{% extends 'base.html' %}
{% load url from future %}

{% load staticfiles %}

{% block title %}Outcomes Map{% endblock %}

{% block bodyclasses %}outcomes-map{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'css/leaflet.ie.css' %}" />
<![endif]-->
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}">
<!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.ie.css' %}" />
<![endif]-->
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/leaflet.markercluster.js' %}"></script>
<script>
    $(document).ready(function(){
            var providers = {{ organisations|safe }},
                map = new L.map('public-map').setView([51.505, -0.09], 13),
                markers = new L.MarkerClusterGroup({
                    disableClusteringAtZoom:14
                });

            // Tiles
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                   attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                   maxZoom: 18
               }).addTo(map);

            // Markers
            $.each(providers, function(index, provider) {
                var latLng = new L.LatLng(provider.lat, provider.lon);
                var marker = new L.Marker(latLng, {
                    title: provider.name,
                    issues_count: provider.issues.length
                });
                var info = "<strong>" + provider.name + "</strong><br/>";
                info += "Type: " + provider.type + "<br/>";
                if (provider.issues.length > 0) {
                    info += provider.issues.length + " Open issues: </br>";
                    info += "<ul>";
                    for(var i = 0; i < provider.issues.length; i++) {
                        info += "<li>" + provider.issues[i] + "</li>";
                    }
                    info += "</ul>"
                }
                else {
                    info += "No Open issues"
                }
                marker.bindPopup(info);
                markers.addLayer(marker);
            });
            map.addLayer(markers);
    });
</script>
{% endblock %}
{% block content %}
<div class="header">
    <h1>Outcomes Map</h1>
</div>
<div class="hero">
    <div class="feature">
        <p><a href="{% url 'org-pick-provider' cobrand=cobrand.name %}">Look up the outcomes of an NHS care provider</a></p>
    </div>
    <div class="feature">
        <p><a href="{% url 'org-all-summary' cobrand=cobrand.name %}">Look at the outcomes summary tables</a></p>
    </div>
</div>
<div class="map-options">
    <div class="feature">
        <p><a href="">London</a></p>
    </div>
    <div class="feature">
        <p><a href="">Manchester</a></p>
    </div>
</div>
<div class="map-container">
    <div id="public-map" class="map">
    </div>
</div>
<div class="map-instructions">
    <div class="feature">
        <p>Click to the see the outcomes of a provider or zoom in to see more detail</p>
    </div>
</div>
{% endblock %}
