{% extends 'base.html' %}
{% load url from future %}

{% load staticfiles %}

{% block title %}Outcomes Map{% endblock %}

{% block bodyclasses %}outcomes-map{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'css/leaflet.rrose.css' %}" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'css/leaflet.ie.css' %}" />
    <link rel="stylesheet" href="{% static 'css/leaflet.rrose.ie.css' %}" />
<![endif]-->
<style type="text/css">
    .marker_m1,
    .marker_m2,
    .marker_m3,
    .marker_m4
    {
        display:block;
        width: 16px;
        height: 16px;
        border-radius:50%;
        border: 2px solid #fff;
        margin: 2em;
        margin-top: 6em;
        float:left;
        cursor: pointer;

        -webkit-box-shadow: 0px 0px 6px 0px #000;
                box-shadow: 0px 0px 6px 0px #000;

    }
    .marker_m1:hover { background:#000;border-color: rgba(216,30,5,1);   }
    .marker_m2:hover { background:#000;border-color: #ef4300;            }
    .marker_m3:hover { background:#000;border-color: rgb(226,140,5);     }
    .marker_m4:hover { background:#000;border-color: rgba(247,226,20,1); }
    {
        border-color: rgba(0,0,0,0.8);
    }
    .marker_m1:hover .popup,
    .marker_m2:hover .popup,
    .marker_m3:hover .popup,
    .marker_m4:hover .popup
    {
        display:block;
        top: -5.8em;
        opacity:1;
    }
    .marker_m1{ background-color: rgba(216,30,5,1); }
    .marker_m2{ background-color: #ef4300; }
    .marker_m3{ background-color: rgb(226,140,5); }
    .marker_m4{ background-color: rgba(247,226,20,1); }

    /* Rrose Tweaks */
    .leaflet-rrose{ pointer-events:none; }
    .leaflet-rrose-content-wrapper, .leaflet-rrose-tip {
        background: rgba(0,0,0,0.8);
    }
    .leaflet-rrose-content-wrapper{
        -webkit-border-radius:0;
        -moz-border-radius:0;
        border-radius:0;
        color: #fff;
        font-size: 16px;
    }
    .leaflet-rrose-content{
        font-size: 14px;
        line-height: 1.4;
        color: #ddd;
    }
    .leaflet-rrose-content strong{
        color:#fff;
        font-size: 16px;
    }
</style>
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/underscore.min.js' %}"></script>
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/rrose-src.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var _getRandomInt = function(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; };
        var _returnRandomArrayItem = function(thearray){ return thearray[_getRandomInt(1, thearray.length)-1]; };

        var providers = {{ organisations|safe }};
        // TODO - when can we set this to false?
        var imageBasedMarkers = true;
        var map = L.map('map');
        var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib='Map data Â© OpenStreetMap contributors';
        var osm = new L.TileLayer(osmUrl, {minZoom: 10, maxZoom: 16, attribution: osmAttrib});

        if(imageBasedMarkers){
            // Image Based: best for backwards compatibility
            var nhsCentreIcon_1 = L.icon({
                iconUrl: "{% static 'img/marker1.png' %}",
                iconRetinaUrl: "{% static 'img/marker1@2x.png' %}",
                iconSize: [16, 16],
                popupAnchor: [-3, -76],
                shadowUrl: "{% static 'img/shadow.png' %}",
                shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                shadowSize: [24, 24]
            });
            var nhsCentreIcon_2 = L.icon({
                iconUrl: "{% static 'img/marker2.png' %}",
                iconRetinaUrl: "{% static 'img/marker2@2x.png' %}",
                iconSize: [16, 16],
                popupAnchor: [-3, -76],
                shadowUrl: "{% static 'img/shadow.png' %}",
                shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                shadowSize: [24, 24]
            });
            var nhsCentreIcon_3 = L.icon({
                iconUrl: "{% static 'img/marker3.png' %}",
                iconRetinaUrl: "{% static 'img/marker3@2x.png' %}",
                iconSize: [16, 16],
                popupAnchor: [-3, -76],
                shadowUrl: "{% static 'img/shadow.png' %}",
                shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                shadowSize: [24, 24]
            });
            var nhsCentreIcon_4 = L.icon({
                iconUrl: "{% static 'img/marker4.png' %}",
                iconRetinaUrl: "{% static 'img/marker4@2x.png' %}",
                iconSize: [16, 16],
                popupAnchor: [-3, -76],
                shadowUrl: "{% static 'img/shadow.png' %}",
                shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                shadowSize: [24, 24]
            });
        } else{
            // Div Based: Prettier but not as compatible.
            var nhsCentreIcon_1 = L.divIcon({className: 'marker_m1'});
            var nhsCentreIcon_2 = L.divIcon({className: 'marker_m2'});
            var nhsCentreIcon_3 = L.divIcon({className: 'marker_m3'});
            var nhsCentreIcon_4 = L.divIcon({className: 'marker_m4'});
        }

        map.setView(new L.LatLng(51.505, -0.09),10);
        map.addLayer(osm);

        providers.forEach(function(nhs_centre){

            L.marker([nhs_centre.lat, nhs_centre.lon], {
                riseOnHover:true,
                // TODO - shouldn't be random, should it be a function of their issue count?
                icon: _returnRandomArrayItem([
                    nhsCentreIcon_1,
                    nhsCentreIcon_2,
                    nhsCentreIcon_3,
                    nhsCentreIcon_4
                ])
            }).on('mouseover', function(e){
                var hover_bubble = new L.Rrose({
                    offset: new L.Point(2,-4),
                    closeButton: false,
                    autoPan: false
                }).setContent(
                    // TODO - if we have to have underscore on the page for debouncing, we should
                    // use it's templating features to make this nicer
                    "<strong>" + nhs_centre.name + "</a></strong>" +
                    "<br><em>" + nhs_centre.problem_count + "</em> Open Problems<br>"
                )
                .setLatLng(e.target._latlng)
                .openOn(map);
            }).on('mouseout', function(e){
                _.debounce(map.closePopup(), 300);
            }).on('click', function(e) {
                // TODO - this feels dirty, but links in the popup don't work
                // because leaflet steals the click events and it's tricky to make
                // the popup stay up long enough
                window.location=nhs_centre.url
            }).addTo(map);

        });
    });
</script>
{% endblock %}
{% block content %}
<div class="header">
    <h1>Outcomes Map</h1>
</div>
{% if not private %}
<div class="hero">
    <div class="feature">
        <p><a href="{% url 'org-pick-provider' cobrand=cobrand.name %}">Look up the outcomes of an NHS care provider</a></p>
    </div>
    <div class="feature">
        <p><a href="{% url 'org-all-summary' cobrand=cobrand.name %}">Look at the outcomes summary tables</a></p>
    </div>
</div>
{% endif %}
<div class="map-options">
    <div class="feature">
        <p><a href="">London</a></p>
    </div>
    <div class="feature">
        <p><a href="">Manchester</a></p>
    </div>
</div>
<div class="map-container">
    <div id="map" class="map">
    </div>
</div>
<div class="map-instructions">
    <div class="feature">
        <p>Click to the see the outcomes of a provider or zoom in to see more detail</p>
    </div>
</div>
{% endblock %}
