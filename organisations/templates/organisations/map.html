{% extends 'base.html' %}
{% load url from future %}

{% load staticfiles %}

{% block title %}Organisation performance data{% endblock %}

{% block bodyclasses %}outcomes-map{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'css/leaflet.rrose.css' %}" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'css/leaflet.ie.css' %}" />
    <link rel="stylesheet" href="{% static 'css/leaflet.rrose.ie.css' %}" />
<![endif]-->
<style type="text/css">
    #map{
        height:500px;
    }
    .marker_m1,
    .marker_m2,
    .marker_m3,
    .marker_m4
    {
        display:block;
        width: 16px;
        height: 16px;
        border-radius:50%;
        border: 2px solid #fff;
        margin: 2em;
        margin-top: 6em;
        float:left;
        cursor: pointer;

        -webkit-box-shadow: 0px 0px 6px 0px #000;
                box-shadow: 0px 0px 6px 0px #000;

    }
    .marker_m1{ background-color: #1e91c9; }
    .marker_m2{ background-color: #176d97; }
    .marker_m3{ background-color: #176d97; }
    .marker_m4{ background-color: #072432; }

    {
        border-color: rgba(0,0,0,0.8);
    }
    .marker_m1:hover .popup,
    .marker_m2:hover .popup,
    .marker_m3:hover .popup,
    .marker_m4:hover .popup
    {
        display:block;
        top: -5.8em;
        opacity:1;
    }
    .marker_m1{ background-color: rgba(216,30,5,1); }
    .marker_m2{ background-color: #ef4300; }
    .marker_m3{ background-color: rgb(226,140,5); }
    .marker_m4{ background-color: rgba(247,226,20,1); }

    /* Rrose Tweaks */
    .leaflet-rrose{ pointer-events:none; }
    .leaflet-rrose-content-wrapper, .leaflet-rrose-tip {
        background: rgba(0,0,0,0.8);
    }
    .leaflet-rrose-content-wrapper{
        -webkit-border-radius:0;
        -moz-border-radius:0;
        border-radius:0;
        color: #fff;
        font-size: 16px;
    }
    .leaflet-rrose-content{
        font-size: 14px;
        line-height: 1.4;
        color: #ddd;
    }
    .leaflet-rrose-content strong{
        color:#fff;
        font-size: 16px;
    }
</style>
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/underscore.min.js' %}"></script>
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/rrose-src.js' %}"></script>
<script src="{% static 'js/wax.leaf.min.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var providers = {{ organisations|safe }};
        var imageBasedMarkers = true;
        var londonCentre = new L.LatLng(51.505, -0.09);
        var northEastCentre = new L.LatLng(54.95, -1.62);
        var londonZoomLevel = 10;
        var northEastZoomLevel = 8;
        var map = new L.Map('map');

        wax.tilejson('http://api.tiles.mapbox.com/v3/jedidiah.map-3lyys17i.jsonp', function(tilejson) {
            map.addLayer(new wax.leaf.connector(tilejson)).setView(londonCentre, 1);
            if(imageBasedMarkers){
                // Image Based: best for backwards compatibility
                var nhsCentreIcon_1 = L.icon({
                    iconUrl: "{% static 'img/marker1.png' %}",
                    iconRetinaUrl: "{% static 'img/marker1@2x.png' %}",
                    iconSize: [16, 16],
                    popupAnchor: [-3, -76],
                    shadowUrl: "{% static 'img/shadow.png' %}",
                    shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                    shadowSize: [24, 24]
                });
                var nhsCentreIcon_2 = L.icon({
                    iconUrl: "{% static 'img/marker2.png' %}",
                    iconRetinaUrl: "{% static 'img/marker2@2x.png' %}",
                    iconSize: [16, 16],
                    popupAnchor: [-3, -76],
                    shadowUrl: "{% static 'img/shadow.png' %}",
                    shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                    shadowSize: [24, 24]
                });
                var nhsCentreIcon_3 = L.icon({
                    iconUrl: "{% static 'img/marker3.png' %}",
                    iconRetinaUrl: "{% static 'img/marker3@2x.png' %}",
                    iconSize: [16, 16],
                    popupAnchor: [-3, -76],
                    shadowUrl: "{% static 'img/shadow.png' %}",
                    shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                    shadowSize: [24, 24]
                });
                var nhsCentreIcon_4 = L.icon({
                    iconUrl: "{% static 'img/marker4.png' %}",
                    iconRetinaUrl: "{% static 'img/marker4@2x.png' %}",
                    iconSize: [16, 16],
                    popupAnchor: [-3, -76],
                    shadowUrl: "{% static 'img/shadow.png' %}",
                    shadowRetinaUrl: "{% static 'img/shadow@2x.png' %}",
                    shadowSize: [24, 24]
                });
            } else {
                // Div Based: Prettier but not as compatible.
                var nhsCentreIcon_1 = L.divIcon({className: 'marker_m1'});
                var nhsCentreIcon_2 = L.divIcon({className: 'marker_m2'});
                var nhsCentreIcon_3 = L.divIcon({className: 'marker_m3'});
                var nhsCentreIcon_4 = L.divIcon({className: 'marker_m4'});
            }

            map.setView(londonCentre, londonZoomLevel);

            providers.forEach(function(nhs_centre){

                // Determine the icon colour based on issue count (crudely)
                var icon_class;
                if(nhs_centre.problem_count <= 3) {
                    icon_class = nhsCentreIcon_4;
                }
                else if(nhs_centre.problem_count <= 6) {
                    icon_class = nhsCentreIcon_3
                }
                else if(nhs_centre.problem_count <= 12) {
                    icon_class = nhsCentreIcon_2
                }
                else {
                    icon_class = nhsCentreIcon_1
                }

                L.marker([nhs_centre.lat, nhs_centre.lon], {
                    riseOnHover:true,
                    icon: icon_class
                }).on('mouseover', function(e){
                    var hover_bubble = new L.Rrose({
                        offset: new L.Point(2,-4),
                        closeButton: false,
                        autoPan: false
                    }).setContent(
                        // TODO - if we have to have underscore on the page for debouncing, we should
                        // use it's templating features to make this nicer
                        "<strong>" + nhs_centre.name + "</a></strong>" +
                        "<br><em>" + nhs_centre.problem_count + "</em> Open Problems<br>"
                    )
                    .setLatLng(e.target._latlng)
                    .openOn(map);
                }).on('mouseout', function(e){
                    _.debounce(map.closePopup(), 300);
                }).on('click', function(e) {
                    // TODO - this feels dirty, but links in the popup don't work
                    // because leaflet steals the click events and it's tricky to make
                    // the popup stay up long enough
                    window.location=nhs_centre.url
                }).addTo(map);
            });
        });

        // Tabs
        $('a#northeast').on('click', function(e) {
            // recenter the map to The north east
            e.preventDefault();
            map.setView(northEastCentre, northEastZoomLevel);
            $('ul.tab-nav a').toggleClass('active');
        });
        $('a#london').on('click', function(e) {
            // recenter the map to london
            e.preventDefault();
            map.setView(londonCentre, londonZoomLevel);
            $('ul.tab-nav a').toggleClass('active');
        });
    });
</script>
{% endblock %}
{% block content %}
{% if not private %}
    <div class="gw">
        <div class="g  one-half  palm-one-whole  mb__palm">
            <a href="{% url 'org-pick-provider' cobrand=cobrand.name %}"  class="btn  btn--no-border  btn--big">Search to find the<br/>profile of an NHS service.</a>
        </div>
        <div class="g  one-half  palm-one-whole">
            <a href="{% url 'org-all-summary' cobrand=cobrand.name %}"  class="btn  btn--no-border  btn--big">View Tables of<br/>NHS Service Profiles</a>
        </div>
    </div>
{% endif %}

<ul class="tab-nav">
    <li><a href="#" id="london" class="active">London</a></li>
    <li><a href="#" id="northeast">The North East</a></li>
</ul>

<div class="map-container">
    <div id="map" class="map"></div>
</div>

<p><small>Zoom into the map above and click on any NHS service shown to see their Care Connect profile.</small></p>
{% endblock %}
