{% extends 'base.html' %}
{% load url from future %}
{% load staticfiles %}

{% block title %}Report your problem{% endblock %}

{% block bodyclasses %}problem-form{% endblock %}

{% block content %}
<div class="header">
    {% if request.GET.organisation_type and request.GET.location %}
        <a href="{% url 'problems-pick-provider' cobrand=cobrand.name %}?organisation_type={{ request.GET.organisation_type|urlencode }}&location={{ request.GET.location|urlencode }}" class="back-btn  fr"><span class="icon-chevron-left" aria-hidden="true"></span> Back to search results</a>
    {% endif %}
    <h1>{{ organisation.name }}</h1>
</div>

<p>All problems posted through this website are highlighted on our live maps. When you submit  your problem here it will be flagged on a marker representing the NHS service you have selected. If you wish you can publish the content of your issue online either anonymously, or with your name.</p>

<form method="post" class="problem-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
        <fieldset class="island">
            {% include "message_list.html" with messages=form.non_field_errors message_type='error' %}
        </fieldset>
    {% endif %}

    {% for hidden in form.hidden_fields %}
        {{ hidden }}
    {% endfor %}

    {% if form.website.errors %}
      <fieldset class="island">
        {# If this error is set then the submission triggered the spam detection. #}
        <ul class="message-list">
          <li class="message-list__error">
            Your submission appears to be auto-generated and has been rejected.
            If you have used a program that automatically fills in some details
            please try again without using it.
          </li>
        </ul>
      </fieldset>
    {% endif %}

    <fieldset class="island">
        <label for="id_service" class="island-label">Your problem</label>

        <label for="id_relates_to_previous_problem" class="label-checkbox">{{ form.relates_to_previous_problem }} Does your problem relate to a previous problem?</label>
        {% include "message_list.html" with messages=form.relates_to_previous_problem.errors message_type='error' %}

        <ul class="gw">
            <li class="g  five-eighths">
                {{ form.description }}
                <p class="info align-right description-count"></a>
                <div class="description-errors">
                    {% include "message_list.html" with messages=form.description.errors message_type='error' %}
                </div>

                {% if not form.service.is_hidden %}
                <p class="info">If your problem relates to a particular service <span class="slim-select">{{ form.service }}</span></p>
                {% include "message_list.html" with messages=form.service.errors message_type='error' %}
                {% endif %}
            </li>

            <li class="g  three-eighths">
                <p class="info">In order to enable us to resolve your problem as quickly and as effectively as possible, please provide as much detail as you can. For example:</p>
                <ul>
                    <li><span class="info">Date the problem occurred</span></li>
                    <li><span class="info">Location/department</span></li>
                    <li><span class="info">Members of staff involved</span></li>
                    <li><span class="info">Name of patient (if not yourself)</span></li>
                </ul>
            </li>
        </ul>
    </fieldset>

    <fieldset class="island">
        <label for="id_category" class="island-label">Category</label>

        <p class="info">Please select the category that best describes your problem</p>

        <ul class="radio-list">
            {% for radio in form.category %}
                <li>{{ radio }}</li>
            {% endfor %}
        </ul>

        {% include "message_list.html" with messages=form.category.errors message_type='error' %}

        <p class="info">Additional questions for some categories (may be greyed out if they do not apply):</p>

        <ul class="gw">
            <li class="g  one-whole">
                <label for="id_elevate_priority">{{ form.elevate_priority }} Is this problem happening now?</label>
            </li>
        </ul>
    </fieldset>

    <fieldset class="island">
        <ul class="gw">
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_name">Your Name <span class="info">You must enter your name</span></label>
                {{ form.reporter_name }}
                {% include "message_list.html" with messages=form.reporter_name.errors message_type='error' %}
            </li>
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_phone">Your Contact Number <span class="info">Optional</span></label>
                {{ form.reporter_phone }}
                {% include "message_list.html" with messages=form.reporter_phone.errors message_type='error' %}
            </li>
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_email">Your Email Address <span class="info">You must enter an email address</span></label>
                {{ form.reporter_email }}
                {% include "message_list.html" with messages=form.reporter_email.errors message_type='error' %}
            </li>
            <li class="g  one-half  pal-one-whole">
                <label for="id_preferred_contact_method_0">Preferred contact method</label>
                <ul class="radio-list">
                    {% for radio in form.preferred_contact_method %}
                        <li>{{ radio }}</li>
                    {% endfor %}
                </ul>
                {% include "message_list.html" with messages=form.preferred_contact_method.errors message_type='error' %}
            </li>

            {% comment %}
              This should never be visible to the user as it has display: none.
              It is a honeypot and should not be filled in.
            {% endcomment %}
            <li class="g  one-half  palm-one-whole" style="display: none">
                <label for="id_website">Leave blank<span class="info">Please leave this field blank</span></label>
                {{ form.website }}
            </li>

        </ul>
    </fieldset>

    <fieldset class="island">
        <label for="id_privacy_0" class="island-label">Privacy settings</label>
        <div class="gw">
            <div class="g  one-third">
            <ul class="big-radio-group">
                <li class="big-radio-group__first  big-radio-group--green">
                    <div class="big-radio-group__table">
                        <label for="id_privacy_0" class="big-radio-group__row">
                            <input checked="checked" type="radio" id="id_privacy_0" value="0" name="privacy" />
                            <span class="big-radio-group__cell">Keep all details private</span>
                        </label>
                    </div>
                </li>
                <li>
                    <div class="big-radio-group__table">
                        <label for="id_privacy_1" class="big-radio-group__row">
                            <input type="radio" id="id_privacy_1" value="1" name="privacy" />
                            <span class="big-radio-group__cell">Publish problem and response but not my name</span>
                        </label>
                    </div>
                </li>
                <li class="big-radio-group__last">
                    <div class="big-radio-group__table">
                        <label for="id_privacy_2" class="big-radio-group__row">
                            <input type="radio" id="id_privacy_2" value="2" name="privacy" />
                            <span class="big-radio-group__cell">Publish problem and response with my name</span>
                        </label>
                    </div>
                </li>
            </ul>
            {% include "message_list.html" with messages=form.privacy.errors message_type='error' %}
        </div>
        <div class="g  two-thirds">

            <ul class="island-list">
                <li>Unless you publish the details of your problem on the site it will remain private between you and the service provider.</li>
                <li>Choosing to publish your problem will make it easier to track.</li>
                <li>You can choose to publish anonymously if you prefer.</li>
                <li>All problems will go though moderation to ensure it meets out publishing criteria, your original message will be passed to the service provider unchanged. See our moderation rules for more information.</li>
            </ul>
        </div>

    </fieldset>

    <fieldset class="island">
        <label class="island-label">What happens next?</label>
        <div class="gw">
            <div class="g  one-quarter">
                <img src="{% static 'img/problem-progress.png' %}" alt="Problem progress steps" />
            </div>
            <div class="g  three-quarters">
                <ul class="steps-list">
                    <li>The NHS Service provider receives details of your problem. The case appears on the live map with its current status.</li>
                    <li>The NHS Service provider contacts you to discuss how your problem can be resolved. You should get a response in X working days.</li>
                    <li>The NHS service provider carries out what you have agreed should happen. If uou are not satisfied with the response you receive, or you do not get a response at all you can re-log your problem.</li>
                    <li>We send you a short questionnaire to say whether you were happy with the solution to your problem.</li>
                </ul>
            </div>
        </div>
    </fieldset>


    <fieldset class="island">
        <ul class="gw">
            <li class="g  two-halfs">
                <label for="id_agree_to_terms" class="label-checkbox">{{ form.agree_to_terms }} I have read and agree to the <a href="{% url 'about' cobrand=cobrand.name %}">Terms and Conditions</a></label>
                {% include "message_list.html" with messages=form.agree_to_terms.errors message_type='error' %}
            </li>
            <li class="g  one-half">
                <button class="btn  fr" type="submit">Submit</button>
            </li>
        </ul>
    </fieldset>
</form>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        window.CitizenConnect = window.CitizenConnect || {};
        window.CitizenConnect.priorityCategories = {};
        {% for cat in CATEGORIES_PERMITTING_SETTING_OF_PRIORITY_AT_SUBMISSION %}
            window.CitizenConnect.priorityCategories.{{cat}} = true;
        {% endfor %}
    </script>
    <script src="{% static 'js/problem-form.js' %}"></script>
{% endblock extra_js %}
