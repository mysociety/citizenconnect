{% extends 'base.html' %}
{% load url from future %}

{% block title %}Report your problem{% endblock %}

{% block bodyclasses %}problem-form{% endblock %}

{% block content %}
<div class="header">
    {% if request.GET.organisation_type and request.GET.location %}
        <a href="{% url 'problems-pick-provider' cobrand=cobrand.name %}?organisation_type={{ request.GET.organisation_type|urlencode }}&location={{ request.GET.location|urlencode }}" class="back-btn  fr"><span class="icon-chevron-left" aria-hidden="true"></span> Back to search results</a>
    {% endif %}
    <h1>{{ organisation.name }}</h1>
</div>

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
        <fieldset class="island">
            {% include "message_list.html" with messages=form.non_field_errors message_type='error' %}
        </fieldset>
    {% endif %}

    {% for hidden in form.hidden_fields %}
        {{ hidden }}
    {% endfor %}

    {% if form.website.errors %}
      <fieldset class="island">
        {# If this error is set then the submission triggered the spam detection. #}
        <ul class="message-list">
          <li class="message-list__error">
            Your submission appears to be auto-generated and has been rejected.
            If you have used a program that automatically fills in some details
            please try again without using it.
          </li>
        </ul>
      </fieldset>
    {% endif %}

    <fieldset class="island">
        <ul class="gw">
            <li class="g  one-whole">
                {{ form.description }}
                <p class="info">In order to enable us to resolve your problem as quickly and as effectively as possible, please provide as much detail as you can. For example:</p>
                <ul>
                    <li><span class="info">Date the problem occurred</span></li>
                    <li><span class="info">Location/department</span></li>
                    <li><span class="info">Members of staff involved</span></li>
                    <li><span class="info">Name of patient (if not yourself)</span></li>
                </ul>
                {% include "message_list.html" with messages=form.description.errors message_type='error' %}
            </li>
        </ul>
    </fieldset>

    {% if not form.service.is_hidden %}
        <fieldset class="island">
            <label for="id_service">Service</label>

            <p class="info">If your problem relates to a particular service, you can select it here</p>

            <ul class="radio-list">
                {% for radio in form.service %}
                    <li>{{ radio }}</li>
                {% endfor %}
            </ul>

            {% include "message_list.html" with messages=form.service.errors message_type='error' %}

        </fieldset>
    {% endif %}

    <fieldset class="island">
        <label for="id_category">Category</label>

        <p class="info">Please select the category that best describes your problem</p>

        <ul class="radio-list">
            {% for radio in form.category %}
                <li>{{ radio }}</li>
            {% endfor %}
        </ul>

        {% include "message_list.html" with messages=form.category.errors message_type='error' %}

        <p class="info">Additional questions for some categories (may be greyed out if they do not apply):</p>

        <ul class="gw">
            <li class="g  one-whole">
                <label for="id_elevate_priority">{{ form.elevate_priority }} I am currently in care</label>
            </li>
        </ul>
    </fieldset>

    <fieldset class="island">
        <ul class="gw">
            <li class="g  one-whole">
                <label for="id_relates_to_previous_problem">{{ form.relates_to_previous_problem }} Relates to previously reported problem</label>
                {% include "message_list.html" with messages=form.relates_to_previous_problem.errors message_type='error' %}
            </li>
        </ul>
    </fieldset>

    <fieldset class="island">
        <ul class="gw">
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_name">Your Name <span class="info">You must enter your name</span></label>
                {{ form.reporter_name }}
                {% include "message_list.html" with messages=form.reporter_name.errors message_type='error' %}
            </li>
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_phone">Your Contact Number <span class="info">You must enter a contact number OR email address</span></label>
                {{ form.reporter_phone }}
                {% include "message_list.html" with messages=form.reporter_phone.errors message_type='error' %}
            </li>
            <li class="g  one-half  palm-one-whole">
                <label for="id_reporter_email">Your Email Address <span class="info">You must enter a contact number OR email address</span></label>
                {{ form.reporter_email }}
                {% include "message_list.html" with messages=form.reporter_email.errors message_type='error' %}
            </li>
            <li class="g  one-half  pal-one-whole">
                <label for="id_preferred_contact_method_0">Preferred contact method</label>
                <ul class="radio-list">
                    {% for radio in form.preferred_contact_method %}
                        <li>{{ radio }}</li>
                    {% endfor %}
                </ul>
                {% include "message_list.html" with messages=form.preferred_contact_method.errors message_type='error' %}
            </li>

            {% comment %}
              This should never be visible to the user as it has display: none.
              It is a honeypot and should not be filled in.
            {% endcomment %}
            <li class="g  one-half  palm-one-whole" style="display: none">
                <label for="id_website">Leave blank<span class="info">Please leave this field blank</span></label>
                {{ form.website }}
            </li>

        </ul>
    </fieldset>

    <fieldset class="island">
        <p>All problems posted through this website are highlighted on our live maps. When you submit your problem here, it will be flagged on a marker representing the NHS service you have selected. If you wish, you can publish the content of your issue online, either anonymously, or with your name.</p>

        <p>Publishing your issue details publicly will make it easier for you to find it and follow its status. It will also help other people too, especially if they are experiencing similar problems to you.</p>

        <p>The contact details you have provided will never be published and we only allow the service you have selected above to contact you to resolve the problem.</p>

        <p>All problems marked both private and public are:</p>
        <ul>
            <li>Instantly sent to the relevant provider</li>
            <li>Flagged on the live dashboard next to the relevant organisation - identifiable only by the category given and are automatically marked with the status &lsquo;open&rsquo;</li>
        </ul>
        <p>All problems marked public are:</p>
        <ul>
            <li>Passed to the case handling team to be moderated (<a href="{% url 'about' cobrand=cobrand.name %}">See the moderation rules</a>)</li>
            <li>If your problem passes moderation it will published on the website in the section marked xxx on the relevant organisationâ€™s dashboard. ( this can take up to 24 hours)</li>
            <li>Your name will be published on the website next to the problem only is you tick the box to allow this.</li>
        </ul>
        <p>If you are still not sure about which privacy option below to select, please do nothing - the default option is for everything to be private.</p>
        <p>Problem resolution</p>
        <ul>
            <li>The organisation will contact you using your preferred method of communication to find a suitable resolution. The organisation may at this point change the status of the problem to &lsquo;in progress&rsquo;</li>
            <li>Once a resolution has been achieved the organisation will remove the flag on the live map. The details of the case will be visible in on the organisation's dashboard with the status &lsquo;resolved&rsquo; applied.</li>
            <li>You will receive a short questionnaire by email a few weeks after posting your problem to find out how satisfied you were with both the outcome and the service.</li>
        </ul>
    </fieldset>

    <fieldset class="big-radio-group">
        <!-- <label for="id_privacy_0">Privacy</label> -->
        <ul>
            <li class="big-radio-group__first  big-radio-group--green">
                <div class="big-radio-group__table">
                    <label for="id_privacy_0" class="big-radio-group__row">
                        <input checked="checked" type="radio" id="id_privacy_0" value="0" name="privacy" />
                        <span class="big-radio-group__cell">Keep all details private</span>
                    </label>
                </div>
            </li>
            <li>
                <div class="big-radio-group__table">
                    <label for="id_privacy_1" class="big-radio-group__row">
                        <input type="radio" id="id_privacy_1" value="1" name="privacy" />
                        <span class="big-radio-group__cell">Publish problem and response but not my name</span>
                    </label>
                </div>
            </li>
            <li class="big-radio-group__last">
                <div class="big-radio-group__table">
                    <label for="id_privacy_2" class="big-radio-group__row">
                        <input type="radio" id="id_privacy_2" value="2" name="privacy" />
                        <span class="big-radio-group__cell">Publish problem and response with my name</span>
                    </label>
                </div>
            </li>
        </ul>
        {% include "message_list.html" with messages=form.privacy.errors message_type='error' %}

        <p class="info">Please be assured that if you choose to publish your issue, either anonymously, or with your name, it will not have any negative impact at all on any NHS service you may experience in the future.</p>

    </fieldset>

    <fieldset class="island">
        <ul class="gw">
            <li class="g  one-whole">
                <label for="id_agree_to_terms">{{ form.agree_to_terms }} I have read and agree to the <a href="{% url 'about' cobrand=cobrand.name %}">Terms and Conditions</a></label>
                {% include "message_list.html" with messages=form.agree_to_terms.errors message_type='error' %}
            </li>
        </ul>
    </fieldset>

    <fieldset>
        <button class="btn  fr" type="submit">Submit</button>
    </fieldset>
</form>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
      $(function(){
        $('.big-radio-group').each(function(){
          var $t = $(this);

          // add dummy radio element
          $('input[type=radio]', $t).each(function(){
            $(this).hide().after('<div class="big-radio-group__cell"><div class="big-radio-group__radio"></div></div>');
          });

          // bind the click event so we can update the actual inputs
          $('li', $t).on('click', function(){
            $('li', $t).removeClass('big-radio-group--active');
            $('input[type=radio]', $(this)).prop("checked", true);
            $(this).addClass('big-radio-group--active');
          });
        });


      });

      // bind the onload event so we can trigger the click on
      // whichever one is already selected
      $(window).load(function(){
        $('.big-radio-group input[type=radio]').each(function(){
          if($(this).is(':checked')){
            console.log('checked!!');
            $(this).parents('li').click();
          }
        });
      });
    </script>

    <script type="text/javascript" charset="utf-8">
      $(function () {

        var priority_categories = {};
        {% for cat in CATEGORIES_PERMITTING_SETTING_OF_PRIORITY_AT_SUBMISSION %}
        priority_categories.{{cat}} = true;{% endfor %}

        $('input[name="category"]')
          .change(function () {
            var val = $(this).val();

            var $label = $('label[for="id_elevate_priority"]');
            var $input = $('#id_elevate_priority');

            if ( priority_categories[val] ) {
              $label.removeClass("disabled");
              $input.prop("disabled", false);
            } else {
              $label.addClass("disabled");
              $input.prop("disabled", "disabled");
            }
          });

        $('input[name="category"]:checked').change();


      });
    </script>
{% endblock extra_js %}
